(window.webpackJsonp=window.webpackJsonp||[]).push([[57],{371:function(t,a,s){"use strict";s.r(a);var _=s(14),r=Object(_.a)({},(function(){var t=this,a=t._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"_6-2-修改相关操作"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-2-修改相关操作"}},[t._v("#")]),t._v(" 6.2 修改相关操作")]),t._v(" "),a("h2",{attrs:{id:"_6-2-1-锁机制"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-2-1-锁机制"}},[t._v("#")]),t._v(" 6.2.1 锁机制")]),t._v(" "),a("p",[t._v("程序运行时，会有很多线程去操作数据，从而导致数据不一致，此时为了控制并发问题，我们会选用锁机制，锁分为悲观锁和乐观锁。")]),t._v(" "),a("h3",{attrs:{id:"_1-悲观锁与乐观锁介绍"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-悲观锁与乐观锁介绍"}},[t._v("#")]),t._v(" 1. 悲观锁与乐观锁介绍")]),t._v(" "),a("h4",{attrs:{id:"_1-悲观锁"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-悲观锁"}},[t._v("#")]),t._v(" 1. 悲观锁")]),t._v(" "),a("p",[t._v("听名字就知道，很悲观，总会认为有人要和他一块改数据，每次拿数据要先上锁，从而只有一个线程可以操作数据。悲观锁在数据库应用比较多的。")]),t._v(" "),a("h4",{attrs:{id:"_2-乐观锁"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-乐观锁"}},[t._v("#")]),t._v(" 2. 乐观锁")]),t._v(" "),a("p",[t._v("乐观锁和悲观锁相反，很乐观的认为没人和他一块改数据，"),a("strong",[t._v("只有在修改数据的时候才会上锁")]),t._v("，并且会有一个version版本比较。")]),t._v(" "),a("blockquote",[a("p",[t._v("例如一个线程拿到ID=1的数据，version是1，修改的时候要保证数据的version是1，不然则认为该条数据被其他线程修改过，从而放弃修改。修改成功后，将version+1。")])]),t._v(" "),a("p",[a("strong",[t._v("ES作为搜索引擎，其场景是读多写少情况，所以它的加锁机制是乐观锁，这样可以提高吞吐量。")])]),t._v(" "),a("p",[a("font",{attrs:{color:"red"}},[a("strong",[t._v("对于乐观锁本书的ES版本和旧版本差距较大，读者需要对照相对应版本的API")])])],1),t._v(" "),a("h3",{attrs:{id:"_2-乐观锁实现方式"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-乐观锁实现方式"}},[t._v("#")]),t._v(" 2. 乐观锁实现方式")]),t._v(" "),a("p",[t._v("ES使用 "),a("code",[t._v("if_seq_no")]),t._v(" 和 "),a("code",[t._v("if_primary_term")]),t._v(" 实现乐观锁")]),t._v(" "),a("ul",[a("li",[a("ol",[a("li",[t._v("_seq_no")])])])]),t._v(" "),a("p",[t._v("递增的版本顺序号，每个文档一个"),a("br"),t._v("\n任何类型的写操作，包括create、update、delete，_seq_no 都会 +1")]),t._v(" "),a("ul",[a("li",[a("ol",{attrs:{start:"2"}},[a("li",[t._v("_primary_term")])])])]),t._v(" "),a("p",[t._v("文档所在主分片的编号，当Primary Shard发生重新分配时，如重启、Primary选举等，_primary_term会递增1。_primary_term主要是用来恢复数据时处理当多个文档的_seq_no一样时的冲突，避免Primary Shard上的写入被覆盖。")]),t._v(" "),a("p",[t._v("添加数据、通过ID查看数据会返回 "),a("code",[t._v("if_seq_no")]),t._v(" 和 "),a("code",[t._v("if_primary_term")]),t._v(" 的值。")]),t._v(" "),a("h3",{attrs:{id:"_3-乐观锁实现过程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-乐观锁实现过程"}},[t._v("#")]),t._v(" 3. 乐观锁实现过程")]),t._v(" "),a("p",[t._v("修改文档时，带上 "),a("code",[t._v("if_seq_no")]),t._v(" 和 "),a("code",[t._v("if_primary_term")]),t._v("，会判断文档当前 "),a("code",[t._v("_seq_no")]),t._v(" 值和参数是否一致，如果一致修改成功，否则修改失败。")]),t._v(" "),a("ul",[a("li",[t._v("乐观锁修改语法")])]),t._v(" "),a("div",{staticClass:"language-json extra-class"},[a("pre",{pre:!0,attrs:{class:"language-json"}},[a("code",[t._v("POST indexname/_update/"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("?if_seq_no="),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("&if_primary_term="),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[t._v('"doc"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token property"}},[t._v('"name"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"修改"')]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("ul",[a("li",[t._v("乐观锁删除语法")])]),t._v(" "),a("div",{staticClass:"language-json extra-class"},[a("pre",{pre:!0,attrs:{class:"language-json"}},[a("code",[t._v("DELETE indexname/_doc/"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("?if_seq_no="),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("&if_primary_term="),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n")])])])])}),[],!1,null,null,null);a.default=r.exports}}]);