<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>4.6 内部缓存原理 | 《ElasticSearch入门到实战》电子书</title>
    <meta name="generator" content="VuePress 1.9.10">
    <script>var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?cf62495503806b1a59f15409bcb76089";
          var s = document.getElementsByTagName("script")[0]; 
          s.parentNode.insertBefore(hm, s);
        })();</script>
    <meta name="description" content="">
    <meta name="keywords" content="elasticsearch,es教程,elasticsearch入门指南,数据分析">
    
    <link rel="preload" href="/assets/css/0.styles.f047b2b2.css" as="style"><link rel="preload" href="/assets/js/app.dac35002.js" as="script"><link rel="preload" href="/assets/js/4.25d5dc7a.js" as="script"><link rel="preload" href="/assets/js/1.564e4eb6.js" as="script"><link rel="preload" href="/assets/js/48.20ef08ca.js" as="script"><link rel="prefetch" href="/assets/js/11.8c57c1b0.js"><link rel="prefetch" href="/assets/js/12.329360ff.js"><link rel="prefetch" href="/assets/js/13.2dfa8441.js"><link rel="prefetch" href="/assets/js/14.963874c8.js"><link rel="prefetch" href="/assets/js/15.6dbae529.js"><link rel="prefetch" href="/assets/js/16.f6c4da71.js"><link rel="prefetch" href="/assets/js/17.f2ca5f26.js"><link rel="prefetch" href="/assets/js/18.df451456.js"><link rel="prefetch" href="/assets/js/19.5b9a9a13.js"><link rel="prefetch" href="/assets/js/2.c6d91782.js"><link rel="prefetch" href="/assets/js/20.7c522e7f.js"><link rel="prefetch" href="/assets/js/21.7f352adf.js"><link rel="prefetch" href="/assets/js/22.9732dad4.js"><link rel="prefetch" href="/assets/js/23.4c4bb30d.js"><link rel="prefetch" href="/assets/js/24.ef57e072.js"><link rel="prefetch" href="/assets/js/25.738f307f.js"><link rel="prefetch" href="/assets/js/26.a4ef7a52.js"><link rel="prefetch" href="/assets/js/27.45a94793.js"><link rel="prefetch" href="/assets/js/28.485f0a88.js"><link rel="prefetch" href="/assets/js/29.adadd52b.js"><link rel="prefetch" href="/assets/js/3.2179dc6c.js"><link rel="prefetch" href="/assets/js/30.89d97153.js"><link rel="prefetch" href="/assets/js/31.83ce7812.js"><link rel="prefetch" href="/assets/js/32.77030c5b.js"><link rel="prefetch" href="/assets/js/33.3fa93b8c.js"><link rel="prefetch" href="/assets/js/34.8abf2e7f.js"><link rel="prefetch" href="/assets/js/35.a359c415.js"><link rel="prefetch" href="/assets/js/36.ca4535ef.js"><link rel="prefetch" href="/assets/js/37.c28c38d4.js"><link rel="prefetch" href="/assets/js/38.6dbac488.js"><link rel="prefetch" href="/assets/js/39.c5013730.js"><link rel="prefetch" href="/assets/js/40.1dc39e50.js"><link rel="prefetch" href="/assets/js/41.724c909a.js"><link rel="prefetch" href="/assets/js/42.6961e5a8.js"><link rel="prefetch" href="/assets/js/43.2498bf23.js"><link rel="prefetch" href="/assets/js/44.07a834a8.js"><link rel="prefetch" href="/assets/js/45.b09417df.js"><link rel="prefetch" href="/assets/js/46.04196af1.js"><link rel="prefetch" href="/assets/js/47.aa588963.js"><link rel="prefetch" href="/assets/js/49.637d1f34.js"><link rel="prefetch" href="/assets/js/5.1e3174d7.js"><link rel="prefetch" href="/assets/js/50.58f90e0f.js"><link rel="prefetch" href="/assets/js/51.786432e8.js"><link rel="prefetch" href="/assets/js/52.03a9b628.js"><link rel="prefetch" href="/assets/js/53.5d20f2f2.js"><link rel="prefetch" href="/assets/js/54.687ea780.js"><link rel="prefetch" href="/assets/js/55.b301d29b.js"><link rel="prefetch" href="/assets/js/56.fb9f453d.js"><link rel="prefetch" href="/assets/js/57.b761f294.js"><link rel="prefetch" href="/assets/js/58.18734ce0.js"><link rel="prefetch" href="/assets/js/59.17fb3b41.js"><link rel="prefetch" href="/assets/js/6.49dd7821.js"><link rel="prefetch" href="/assets/js/60.21cbf1ab.js"><link rel="prefetch" href="/assets/js/61.c6730ca7.js"><link rel="prefetch" href="/assets/js/62.c97f6f80.js"><link rel="prefetch" href="/assets/js/63.3dbc36d7.js"><link rel="prefetch" href="/assets/js/64.dc6cc472.js"><link rel="prefetch" href="/assets/js/7.71819138.js"><link rel="prefetch" href="/assets/js/8.f5318518.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.0928da61.js">
    <link rel="stylesheet" href="/assets/css/0.styles.f047b2b2.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">《ElasticSearch入门到实战》电子书</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/guide/" class="nav-link">
  一起交流
</a></div><div class="nav-item"><a href="/sponsor.html" class="nav-link">
  赞助
</a></div><div class="nav-item"><a href="https://github.com/chaosopen/elasticsearch_in_action" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/guide/" class="nav-link">
  一起交流
</a></div><div class="nav-item"><a href="/sponsor.html" class="nav-link">
  赞助
</a></div><div class="nav-item"><a href="https://github.com/chaosopen/elasticsearch_in_action" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/" aria-current="page" class="sidebar-link">首页</a></li><li><section class="sidebar-group depth-0"><a href="/chapter1/index" class="sidebar-heading clickable"><span>第一章：起步</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/chapter1/elastic_search_intro.html" class="sidebar-link">1.1 初识ElasticSearch</a></li><li><a href="/chapter1/install_elastic_search.html" class="sidebar-link">1.2 搭建ElasticSearch环境</a></li><li><a href="/chapter1/elastic_search_client.html" class="sidebar-link">1.3 ElasticSearch客户端</a></li><li><a href="/chapter1/elastic_search_client_coding.html" class="sidebar-link">1.4 程序连接ElasticSearch</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/chapter2/index" class="sidebar-heading clickable"><span>第二章：ElasticSearch基础操作</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/chapter2/index_operation.html" class="sidebar-link">2.1 索引操作</a></li><li><a href="/chapter2/mapping_operation.html" class="sidebar-link">2.2 映射操作</a></li><li><a href="/chapter2/document_operation.html" class="sidebar-link">2.3 文档数据操作</a></li><li><a href="/chapter2/field_type_intro.html" class="sidebar-link">2.4 字段类型介绍</a></li><li><a href="/chapter2/segment_word_search.html" class="sidebar-link">2.5 分词操作介绍</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/chapter3/index" class="sidebar-heading clickable"><span>第三章：ElasticSearch进阶高级操作</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/chapter3/select_grammar.html" class="sidebar-link">3.1 查询语法</a></li><li><a href="/chapter3/rank_search.html" class="sidebar-link">3.2 排序</a></li><li><a href="/chapter3/aggs_search.html" class="sidebar-link">3.3 聚合搜索</a></li><li><a href="/chapter3/monitor.html" class="sidebar-link">3.4 ES状态监控</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/chapter4/index" class="sidebar-heading clickable open"><span>第四章：抽丝剥茧深入底层精通ES</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/chapter4/architecture_design.html" class="sidebar-link">4.1 架构设计</a></li><li><a href="/chapter4/workflow.html" class="sidebar-link">4.2 内部工作流程</a></li><li><a href="/chapter4/inverted_index.html" class="sidebar-link">4.3 深入理解倒排索引</a></li><li><a href="/chapter4/score_model.html" class="sidebar-link">4.4 评分模型</a></li><li><a href="/chapter4/election_mechanism.html" class="sidebar-link">4.5 ES中Master选举机制</a></li><li><a href="/chapter4/data_buffer.html" aria-current="page" class="active sidebar-link">4.6 内部缓存原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/chapter4/data_buffer.html#_4-6-1-node-查询缓存" class="sidebar-link">4.6.1 Node 查询缓存</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/chapter4/data_buffer.html#_1-什么情况下发生nodequerycache" class="sidebar-link">1. 什么情况下发生NodeQueryCache</a></li><li class="sidebar-sub-header"><a href="/chapter4/data_buffer.html#_2-cache相关配置" class="sidebar-link">2. Cache相关配置</a></li></ul></li><li class="sidebar-sub-header"><a href="/chapter4/data_buffer.html#_4-6-2-shardcache" class="sidebar-link">4.6.2 ShardCache</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/chapter4/data_buffer.html#_1-cache-失效策略" class="sidebar-link">1. Cache 失效策略</a></li><li class="sidebar-sub-header"><a href="/chapter4/data_buffer.html#_2-参数配置" class="sidebar-link">2. 参数配置</a></li><li class="sidebar-sub-header"><a href="/chapter4/data_buffer.html#_3-request-cache作用" class="sidebar-link">3. Request Cache作用</a></li></ul></li><li class="sidebar-sub-header"><a href="/chapter4/data_buffer.html#_4-6-3-indexing-buffer" class="sidebar-link">4.6.3 Indexing Buffer</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/chapter4/data_buffer.html#_1-参数配置" class="sidebar-link">1. 参数配置</a></li><li class="sidebar-sub-header"><a href="/chapter4/data_buffer.html#_2-注意事项" class="sidebar-link">2. 注意事项</a></li></ul></li><li class="sidebar-sub-header"><a href="/chapter4/data_buffer.html#_4-6-4-fielddata-cache" class="sidebar-link">4.6.4 FieldData Cache</a></li><li class="sidebar-sub-header"><a href="/chapter4/data_buffer.html#_4-6-5-页缓存" class="sidebar-link">4.6.5 页缓存</a></li></ul></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/chapter5/index" class="sidebar-heading clickable"><span>第五章：电商搜索引擎实战</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/chapter5/search_architecture.html" class="sidebar-link">5.1 搜索引擎架构设计</a></li><li><a href="/chapter5/canal_mysql_sync_data.html" class="sidebar-link">5.2 使用Canal进行MySQL数据同步</a></li><li><a href="/chapter5/project_write.html" class="sidebar-link">5.3 搜索实战项目示例</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/chapter6/index" class="sidebar-heading clickable"><span>第六章：高阶API文档</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/chapter6/query_operation.html" class="sidebar-link">6.1 查询相关操作</a></li><li><a href="/chapter6/update_operation.html" class="sidebar-link">6.2 修改相关操作</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/chapter7/index" class="sidebar-heading clickable"><span>第七章：ES性能优化</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/chapter7/deploy_optimization.html" class="sidebar-link">7.1 部署优化</a></li><li><a href="/chapter7/run_optimization.html" class="sidebar-link">7.2 运行时优化</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/issues/index" class="sidebar-heading clickable"><span>ES错误解决方案</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/issues/install_issue.html" class="sidebar-link">1. 安装错误</a></li></ul></section></li><li><a href="/sponsor.html" class="sidebar-link">赞助</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_4-6-内部缓存原理"><a href="#_4-6-内部缓存原理" class="header-anchor">#</a> 4.6 内部缓存原理</h1> <p>ES查询过程中会占用CPU、内存资源，而内存会令很多读者头疼，内存一直很高，不知道是哪里的问题，想优化，但是不懂其原理便会无从下手，所以了解内存里的缓存原理是很有必要。</p> <p><strong>清理缓存有以下几种方式</strong></p> <ol><li>关闭索引 <a href="/chapter2/index_operation.html#_1-关闭索引">查看</a></li> <li>使用清理缓存命令</li></ol> <p>清空所有缓存</p> <div class="language-json extra-class"><pre class="language-json"><code>POST _cache/clear
</code></pre></div><p>清空<code>1个或多个</code>索引缓存</p> <div class="language-json extra-class"><pre class="language-json"><code>POST indexname<span class="token punctuation">,</span>product_index/_cache/clear
</code></pre></div><h2 id="_4-6-1-node-查询缓存"><a href="#_4-6-1-node-查询缓存" class="header-anchor">#</a> 4.6.1 Node 查询缓存</h2> <p>Node级别的filter过滤器结果缓存，集群中的每个节点包含一个Node Query Cache，作用域是Node实例，由该节点的所有 shard 共享，Cache 采用 LRU 算法进行淘汰。</p> <h3 id="_1-什么情况下发生nodequerycache"><a href="#_1-什么情况下发生nodequerycache" class="header-anchor">#</a> 1. 什么情况下发生NodeQueryCache</h3> <ol><li>只有Filter下的子Query才能缓存</li> <li>不能缓存的Query
TermQuery/MatchAllDocsQuery/MatchNoDocsQuery/BooleanQuery/DisjunnctionMaxQuery</li> <li>MultiTermQuery/MultiTermQueryConstantScoreWrapper/TermInSetQuery/Point*Query的Query查询超过2次会被Cache，其它Query要5次</li> <li>默认每个Segment大于10000个doc或每个段的doc数大于总doc数的30%时才允许参与cache。</li> <li>结果集比较大的Query在Cache时尽量增加使用周期以免频繁Cache构建DocIdset。</li> <li>Segment被合并或者删除，那么也会清理掉对应的缓存。</li> <li>该内存无法被GC</li></ol> <h3 id="_2-cache相关配置"><a href="#_2-cache相关配置" class="header-anchor">#</a> 2. Cache相关配置</h3> <ol><li>indices.queries.cache.size：为每个节点配置缓存的内存大小，默认是10%，支持两种格式，一种是百分数，占节点heap的百分比，另一种是精确的值，如512mb，这个参数是静态的配置后需要重启节点生效。</li> <li>index.queries.cache.enabled：属于index级别的配置，用来控制是否启用缓存，默认是开启的。</li></ol> <p>缓存策略初始化在Node初始化的时候完成，Query Cache在Node层面，如果想把Cache基于每个Shard层面，需要把属性index.queries.cache.everything设置为true(默认false)</p> <h2 id="_4-6-2-shardcache"><a href="#_4-6-2-shardcache" class="header-anchor">#</a> 4.6.2 ShardCache</h2> <p>针对 ES 的 query 请求，缓存各分片的查询结果，主要用于缓存聚合结果，采用LRU机制，当分片 refresh 后会失效。Shard Request Cache是分片级别的查询缓存，每个分片有自己的缓存。该缓存采用 LRU 机制，缓存的 key 是整个客户端请求，缓存内容为单个分片的查询结果。如果一个客户端请求被数据节点缓存了，下次查询的时候可以直接从缓存获取，无需对分片进行查询。Shard查询缓存的理念是对请求的完整响应进行缓存，不需要执行任何搜索，并且基本上可以立即返回响应 — 只要数据没有更改，以确保您不会返回任何过时数据</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token class-name">Key</span> key <span class="token operator">=</span>  <span class="token keyword">new</span> <span class="token class-name">Key</span><span class="token punctuation">(</span>cacheEntity<span class="token punctuation">,</span> reader<span class="token punctuation">.</span><span class="token function">getReaderCacheHelper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cacheKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>cacheEntity， 主要是 shard信息，代表该缓存是哪个 shard上的查询结果。</li> <li>readerCacheKey， 主要用于区分不同的 IndexReader。 cacheKey， 主要是整个客户端请求的请求体（source）和请求参数（preference、indexRoutings、requestCache等）。由于客户端请求信息直接序列化为二进制作为缓存 key 的一部分，所以客户端请求的 json 顺序，聚合名称等变化都会导致 cache 无法命中。</li></ul> <h3 id="_1-cache-失效策略"><a href="#_1-cache-失效策略" class="header-anchor">#</a> 1. Cache 失效策略</h3> <p>Request Cache是非常智能的，它能够保证和在近实时搜索中的非缓存查询结果一致。</p> <blockquote><p>Request Cache缓存失效是自动的，当索引refresh时就会失效，所以其生命周期是一个refresh_interval，也就是说在默认情况下Request Cache是每1秒钟失效一次（注意：分片在这段时间内确实有改变才会失效）。当一个文档被索引到该文档变成Searchable之前的这段时间内，不管是否有请求命中缓存该文档都不会被返回，正是因为如此ES才能保证在使用Request Cache的情况下执行的搜索和在非缓存近实时搜索的结果一致。</p></blockquote> <h3 id="_2-参数配置"><a href="#_2-参数配置" class="header-anchor">#</a> 2. 参数配置</h3> <ol><li>index.requests.cache.enable：默认为true，启动RequestCache配置。</li> <li>indices.requests.cache.size：RequestCache占用JVM的百分比，默认情况下是JVM堆的1%大小</li> <li>indices.requests.cache.expire：配置过期时间，单位为分钟。</li></ol> <p>每次请求的时候使用query-string参数可以指定是否使用Cache（request_cache=true），这个会覆盖Index级别的设置。</p> <h3 id="_3-request-cache作用"><a href="#_3-request-cache作用" class="header-anchor">#</a> 3. Request Cache作用</h3> <p>Request Cache 的主要作用是对聚合的缓存，聚合过程是实时计算，通常会消耗很多资源，缓存对聚合来说意义重大。</p> <p>只有客户端查询请求中 size=0的情况下才会被缓存，其他不被缓存的条件还包括 scroll、设置了 profile属性，查询类型不是 QUERY_THEN_FETCH，以及设置了 requestCache=false等。另外一些存在不确定性的查询例如：范围查询带有now，由于它是毫秒级别的，缓存下来没有意义，类似的还有在脚本查询中使用了 Math.random() 等函数的查询也不会进行缓存。</p> <p>该缓存使用LRU淘汰策略，内存无法被GC。</p> <ol><li>默认被开启，ES6.71版本之后。</li> <li>RequestCache作用域为Node，在Node中的Shard共享这个Cache空间。。</li> <li>RequestCache 是以查询的DSL整个串为key的，修改一个字符和顺序都需要重新生成Cache。</li> <li>缓存失效是索引的refresh操作，也可以设置失效时间。</li> <li>缓存的默认大小是JVM堆内存的1%，可以通过手动设置。</li></ol> <h2 id="_4-6-3-indexing-buffer"><a href="#_4-6-3-indexing-buffer" class="header-anchor">#</a> 4.6.3 Indexing Buffer</h2> <p>索引缓冲区，用于存储新索引的文档，当其达到阈值时，会触发 ES flush 将段落到磁盘上。Lucene文件写入Indexing Buffer中，这时文件不能搜索，但触发refresh后，进入Page Cache后形成Segment就可以被搜索，这个也是ES NRT近实时搜索特性的原因。</p> <h3 id="_1-参数配置"><a href="#_1-参数配置" class="header-anchor">#</a> 1. 参数配置</h3> <p>以下设置是静态的，必须在群集中的每个数据节点上进行配置：</p> <ul><li>indices.memory.index_buffer_size 接受百分比或字节大小的值。 它默认为10％，这意味着分配给一个节点的总堆栈的10％将用作所有分片共享的索引缓冲区大小。</li> <li>indices.memory.min_index_buffer_size 如果将index_buffer_size指定为百分比，则可以使用此设置指定绝对最小值。 默认值为48mb。</li> <li>ndices.memory.max_index_buffer_size 如果index_buffer_size被指定为百分比，则可以使用此设置来指定绝对最大值。 默认为限制</li></ul> <h3 id="_2-注意事项"><a href="#_2-注意事项" class="header-anchor">#</a> 2. 注意事项</h3> <p>由于可以GC，有flush操作，不需要特殊的关注。Indexing Buffer是用来缓存新数据，当其满了或者refresh/flush interval到了，就会以segment file的形式写入到磁盘。 这个参数的默认值是10% heap size。根据经验，这个默认值也能够很好的工作，应对很大的索引吞吐量。 但有些用户认为这个buffer越大吞吐量越高，因此见过有用户将其设置为40%的。到了极端的情况，写入速度很高的时候，40%都被占用，导致OOM</p> <h2 id="_4-6-4-fielddata-cache"><a href="#_4-6-4-fielddata-cache" class="header-anchor">#</a> 4.6.4 FieldData Cache</h2> <p>用于 text 字段分词或排序时获取字段值，基于 lucene 的 segment 构建，伴随 segment 生命周期常驻在堆内存中。</p> <p>Fielddata Cache做了解即可，使用它的也非常的少了，基本可以用doc_value代替了，doc_value使用不需要全部载入内存。</p> <h2 id="_4-6-5-页缓存"><a href="#_4-6-5-页缓存" class="header-anchor">#</a> 4.6.5 页缓存</h2> <p>ES的读写操作是基于Lucene完成的，Lucene的读写操作是基于Segnemt。Segment具有不变性，一旦生成，无法修改。这样，把Segment加载到Page Cache进行读操作是很高效的，写操作也是先写入Page Cache，然后flush到磁盘，推荐Page Cache占整个内存的50%。ES的写操作只有增加和删除，并没有修改（修改API是先删除再新增），有写操作的时候Page Cache会有脏页。</p> <p>Linux除了通过对read，write函数的调用实现数据的读写，还提供了一种方式，对文件数据进行读写，即利用mmap函数。</p> <p>mmap与read相比的优势在于：少了一次内存从内核空间到用户空间的拷贝，对于需要常驻内存的文件和随机读取场景更适用；而反过来read的优势在于，调用开销少，不需要构建内存映射的页表等操作（包括unmap），对于少量顺序读取或者读取完就丢弃的场景更适用。</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">11/12/2023, 9:50:28 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/chapter4/election_mechanism.html" class="prev">
        4.5 ES中Master选举机制
      </a></span> <span class="next"><a href="/chapter5/search_architecture.html">
        5.1 搜索引擎架构设计
      </a>
      →
    </span></p></div> <div style="text-align:center;"></div> <div style="text-align:center;"><a target="_blank" href="http://qm.qq.com/cgi-bin/qm/qr?_wv=1027&amp;k=jj_4DEzjFnjnAMhiLJedoETcx7ER2n8F&amp;authKey=hAHOoupY6JeUw1YAabj1T6VVIPBEiA4dEhUTLaKIcXrFH1vzRwRS3VQykRPVf%2FUm&amp;noverify=0&amp;group_code=564759181">点击加入Q群：564759181</a></div> <div class="copyright"><a target="_blank" href="https://beian.miit.gov.cn">豫ICP备2023030173号-1</a></div> <div class="copyright"> 
        版权所有，禁止私自克隆网站。
      </div></main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.dac35002.js" defer></script><script src="/assets/js/4.25d5dc7a.js" defer></script><script src="/assets/js/1.564e4eb6.js" defer></script><script src="/assets/js/48.20ef08ca.js" defer></script>
  </body>
</html>
